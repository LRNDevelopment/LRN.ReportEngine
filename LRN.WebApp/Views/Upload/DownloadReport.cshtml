@{
    ViewBag.Title = "Download Report";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="download-container">
    <div id="loader"><div class="spinner"></div></div>

    <h2>Download Report</h2>

   @using (Html.BeginForm(actionName: "Download", controllerName: "Upload", method: FormMethod.Post, htmlAttributes: new { id = "reportForm", action = Url.Action("Download", "Upload") }))
    {
        @Html.AntiForgeryToken()
        <div class="form-group">
            <label for="reportType">Select Report Type:</label>
            @Html.DropDownList("reportType", new SelectList(ViewBag.ReportTypes as List<SelectListItem>, "Value", "Text"), "-- Select --", new { @class = "form-control", id = "reportType" })
        </div>

        <div class="form-group" style="display:none;">
            <label for="fromDate">From Date:</label>
            <input type="date" name="fromDate" id="fromDate" class="form-control" style="max-width: 378px;"/>
        </div>

      <div class="form-group" style="display:none;">
            <label for="toDate">To Date:</label>
            <input type="date" name="toDate" id="toDate" class="form-control" style="max-width: 378px;"/>
        </div>

        <div class="validation-error" id="validationMessage"></div>

        <button type="submit">Download Report</button>
    }
</div>

<script>
    document.getElementById("reportForm").addEventListener("submit", function (e) {
        const reportType = document.getElementById("reportType").value;
        const fromDate = document.getElementById("fromDate").value;
        const toDate = document.getElementById("toDate").value;
        const errorDiv = document.getElementById("validationMessage");

        errorDiv.style.display = "none";
        errorDiv.textContent = "";

        if (!reportType) {
            e.preventDefault();
            errorDiv.textContent = "Please select a report type.";
            errorDiv.style.display = "block";
            return;
        }

        if ((fromDate && !toDate) || (!fromDate && toDate)) {
            e.preventDefault();
            errorDiv.textContent = "Please select both From and To dates, or leave both empty.";
            errorDiv.style.display = "block";
            return;
        }

        if (fromDate && toDate && new Date(toDate) < new Date(fromDate)) {
            e.preventDefault();
            errorDiv.textContent = "To Date cannot be earlier than From Date.";
            errorDiv.style.display = "block";
            return;
        }

        // Show loader
        document.getElementById("loader").style.display = "flex";

        // Fallback: hide loader after 10 seconds in case download failed silently
        setTimeout(() => {
            document.getElementById("loader").style.display = "none";
        }, 18000);
    });
</script>


